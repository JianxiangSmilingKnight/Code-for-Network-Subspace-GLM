
```{r}
source("case_study_function.R")
load("case_study_data_ORG_conflict.Rda")
A1<-case_study_data_ORG_conflict$A1
A2<-case_study_data_ORG_conflict$A2
```
#choosing network \hat{P} and r regression
```{r}
G<-(A1+A2)/2
USVT_reg<-USVT.orig(G)

logit.school.data<-case_study_data_ORG_conflict$df
summary(as.factor(logit.school.data$SCHID))
x<-as.factor(logit.school.data$SCHID)
school_coded<-model.matrix(~x-1)
school_coded<-school_coded[,-1]
```
#X.true is the selected covariates
```{r}
W<-logit.school.data$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data$NOMINF>0)
GPA<-logit.school.data$GPA
gender<-as.numeric(logit.school.data$GENDER)-1
grade<-as.numeric(logit.school.data$GR)-1
treat<-as.numeric(logit.school.data$TREAT==2)
ETHA<-as.numeric(logit.school.data$ETHA)-1
ETHB<-as.numeric(logit.school.data$ETHB)-1
ETHW<-as.numeric(logit.school.data$ETHW)-1
ETHH<-as.numeric(logit.school.data$ETHH)-1
HOSN<-as.numeric(logit.school.data$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data),ncol = 1)
X<-cbind(GPA,NOMINF,HOSN,gender,grade,treat,ETHA,ETHB,ETHW,ETHH,Lan,school_coded)
Y_D<-DE
X.true <- X
X.true<-cbind(intercept,X.true)
```

#Perform backward elimination for naive logistic reg and SP logistic reg, the 7th column is treatment
```{r}
full_model<-logistic.back(X.true,Y_D,0.95,0.05,keep.index =c(7))
X_Naive<-full_model$X

full_model<-SP.back(X.true,Y_D,G,USVT_reg$Km,0.95,0.05,keep.index =c(7))
X_SP<-full_model$X

```
#Our method
```{r}
time1<-Sys.time()
fit<-SP.Inf(X_SP,Y_D,G,K=USVT_reg$Km,thr = 0.95)
time2<-Sys.time()
time2-time1
print(fit$chisq.value)
```
#model fitting results for our method
```{r}
M<-fit$coef.mat
row.names(M)<-colnames(X_SP)
```
#model fitting results for logistic reg
```{r}
NL<- glm(matrix(Y_D,ncol=1)~0+X_Naive,family = "binomial",control = list(maxit = 100))
estimate<-NL$coefficients
pvalue<-summary(NL)$coefficients[, 4]
M_NL<-cbind(estimate,pvalue)
```
#model fitting results for RNC
```{r}
gamma<-0.05
X<-X.true[,2:12]
D <- diag(rowSums(G))
n<-nrow(G)
L <- D - G + diag(rep(gamma,n))
L_gamma<-L+gamma*diag(n)
eigen_decomp <- eigen(L_gamma, symmetric = TRUE)
X<-cbind(X,(eigen_decomp$vectors))
Y<-Y_D
time1<-Sys.time()
penalty_factors <- c(rep(0, 11), eigen_decomp$values)
cv_fit <- cv.glmnet(X, Y, family = "binomial",nfolds = 10, penalty.factor = penalty_factors, alpha = 0,lambda =  exp(seq(log(1000),log(0.001),length.out=10)))
optimal_lambda <- cv_fit$lambda.min
fit <- glmnet(X, Y, family = "binomial", alpha = 0,intercept = FALSE, penalty.factor =penalty_factors,lambda = optimal_lambda)
time2<-Sys.time()
time2-time1

M_RNC<-as.matrix(fit$beta[1:11])
row.names(M_RNC)<-colnames(X.true[,2:12])
```

```{r}
print(M)
print(M_NL)
print(M_RNC)
```

#alpha plot
```{r}
n<-nrow(logit.school.data)
separation_values <- diff(as.numeric(x))

# Print the separation values
which(separation_values>0)
fit<-SP.Inf(X_SP,Y_D,G,K=USVT_reg$Km,thr = 0.95)
plot(fit$alpha,lwd=10^{-10},cex = 0.2,pch = 9,col=x, ylab = TeX("$\\alpha$"))

text((which(separation_values>0)[1]+0)/2,-15, "Sch1",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[1]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[1]+334)/2,-15, "Sch3",cex = 0.5,srt=90)
abline(v = 333.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[2]+334)/2,-15, "Sch10",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[2]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[2]+which(separation_values>0)[3])/2,-15, "Sch13",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[3]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[3]+which(separation_values>0)[4])/2,-15, "Sch19",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[4]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[4]+which(separation_values>0)[5])/2,-15, "Sch20",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[5]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[5]+which(separation_values>0)[6])/2,-15, "Sch21",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[6]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[6]+which(separation_values>0)[7])/2,-15, "Sch22",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[7]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[7]+which(separation_values>0)[8])/2,-15, "Sch24",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[8]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[8]+which(separation_values>0)[9])/2,-15, "Sch26",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[9]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[9]+which(separation_values>0)[10])/2,-15, "Sch27",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[10]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[10]+which(separation_values>0)[11])/2,-15, "Sch29",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[11]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[11]+which(separation_values>0)[12])/2,-15, "Sch31",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[12]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[12]+which(separation_values>0)[13])/2,-15, "Sch34",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[13]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[13]+which(separation_values>0)[14])/2,-15, "Sch35",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[14]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[14]+which(separation_values>0)[15])/2,-15, "Sch40",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[15]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[15]+which(separation_values>0)[16])/2,-15, "Sch42",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[16]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[16]+which(separation_values>0)[17])/2,-15, "Sch44",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[17]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[17]+which(separation_values>0)[18])/2,-15, "Sch45",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[18]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[18]+which(separation_values>0)[19])/2,-15, "Sch48",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[19]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[19]+which(separation_values>0)[20])/2,-15, "Sch49",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[20]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[20]+which(separation_values>0)[21])/2,-15, "Sch51",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[21]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[21]+which(separation_values>0)[22])/2,-15, "Sch56",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[22]+0.5, col = "gray", lty = "dashed")

text((which(separation_values>0)[22]+which(separation_values>0)[23])/2,-15, "Sch58",cex = 0.5,srt=90)
abline(v = which(separation_values>0)[23]+0.5, col = "gray", lty = "dashed")
text((which(separation_values>0)[23]+n)/2,-15, "Sch60",cex = 0.5,srt=90)

```

#Select five schools with strong network effect
```{r}
x<-as.factor(logit.school.data$SCHID)
diff_ran<-rep(0,length(unique(x)))
d=0
for (i in unique(x)) {
  d=d+1
  index<-(x==i)
  xbeta<-(X_SP%*%fit$beta)[index]
alpha <- fit$alpha[index]
diff_ran[d]<-mean(abs(alpha))/mean(abs(xbeta))
}
x<-as.factor(logit.school.data$SCHID)
plot(diff_ran, type = "o", xaxt = "n", xlab = "Names of Elements")
axis(1, at = 1:length(diff_ran), labels = unique(x), cex.axis = 0.7)
top5_indices <- order(diff_ran, decreasing = TRUE)[1:5]
unique(x)[top5_indices]
```
#Select five schools with strong network effect, the results show that we select same 5 schools through 200-fold cross validation
```{r}
load("cv_order.Rda")
h=200
n<-nrow(X.true)
cv_order_index<-1:n
A_new<-G

###Our method
usvt.reg <- USVT.orig(A_new)
Y<-as.matrix(Y_D)
X<-X_SP
school_choice<-matrix(0,nrow = h,ncol = 5)
for (II in 1:h) {
  index <- c(cv_order_index[cv_order!=II],cv_order_index[cv_order==II])
    M <- sum(cv_order==II)
  #index <- sample(1:n,n,replace=FALSE)

  perm.X <- X[index,]
  perm.Y <- Y[index,]
  perm.A.orig <- A_new[index,index]
  tmp.result <- NULL
    SP.perm <- SP.semi.Inf(X=perm.X,Y = matrix(perm.Y[1:(n-M)],ncol=1),A=perm.A.orig,K = USVT_reg$Km,r=0,thr=0.95)
    prediction[cv_order==II,]<-SP.perm$full.fitted
x<-as.factor(logit.school.data$SCHID[cv_order!=II])
diff_ran<-rep(0,length(unique(x)))
d=0
for (i in unique(x)) {
  d=d+1
  index<-(x==i)
  xbeta<-(perm.X%*%SP.perm$beta)[index]
alpha <-SP.perm$alpha[index]
diff_ran[d]<-mean(abs(alpha))/mean(abs(xbeta))
}
top5_indices <- order(diff_ran, decreasing = TRUE)[1:5]
school_choice[II,]<-unique(x)[top5_indices]
}
```

#sub network for top 5 school
```{r}
x<-as.factor(logit.school.data$SCHID)
index<-which(x %in% c("1","22","27","31","48"))
logit.school.data_sub<-logit.school.data[index,]
x<-as.factor(logit.school.data_sub$SCHID)
school_coded<-model.matrix(~x-1)
school_coded<-school_coded[,-1]
```
```{r}
W<-logit.school.data_sub$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data_sub$NOMINF>0)
GPA<-logit.school.data_sub$GPA
gender<-as.numeric(logit.school.data_sub$GENDER)-1
grade<-as.numeric(logit.school.data_sub$GR)-1
treat<-as.numeric(logit.school.data_sub$TREAT==2)
ETHA<-as.numeric(logit.school.data_sub$ETHA)-1
ETHB<-as.numeric(logit.school.data_sub$ETHB)-1
ETHW<-as.numeric(logit.school.data_sub$ETHW)-1
ETHH<-as.numeric(logit.school.data_sub$ETHH)-1
HOSN<-as.numeric(logit.school.data_sub$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data_sub$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data_sub),ncol = 1)
X<-cbind(GPA,NOMINF,HOSN,gender,grade,treat,ETHA,ETHB,ETHW,ETHH,Lan,school_coded)
Y_D<-DE
X.true <- X
X.true<-cbind(intercept,X.true)
G_sub<-G[index,index]
USVT_reg<-USVT.orig(G_sub)
```
#backward elimination
```{r}
full_model<-logistic.back(X.true,Y_D,0.95,0.05,keep.index =c(7))
X_Naive<-full_model$X
full_model<-SP.back(X.true,Y_D,G_sub,USVT_reg$Km,0.95,0.05,keep.index =c(7))
X_SP<-full_model$X
fit<-SP.Inf(X_SP,Y_D,G_sub,K=USVT_reg$Km,thr = 0.95)
M<-fit$coef.mat
row.names(M)<-colnames(X_SP)

NL<- glm(matrix(Y_D,ncol=1)~0+X_Naive,family = "binomial")
estimate<-NL$coefficients
pvalue<-summary(NL)$coefficients[, 4]
M_NL<-cbind(estimate,pvalue)
```
#RNC for sub-network
```{r}
n<-nrow(G_sub)
gamma<-0.05
X<-X.true[,2:12]
D <- diag(rowSums(G_sub))
L <- D - G_sub + diag(rep(gamma,n))
L_gamma<-L+gamma*diag(n)
eigen_decomp <- eigen(L_gamma, symmetric = TRUE)
X<-cbind(X,(eigen_decomp$vectors))
Y<-Y_D
time1<-Sys.time()
penalty_factors <- c(rep(0, 11), eigen_decomp$values)
cv_fit <- cv.glmnet(X, Y, family = "binomial",nfolds = 10, penalty.factor = penalty_factors, alpha = 0,lambda =  exp(seq(log(1000),log(0.001),length.out=10)))
optimal_lambda <- cv_fit$lambda.min
fit <- glmnet(X, Y, family = "binomial", alpha = 0,intercept = FALSE, penalty.factor =penalty_factors,lambda = optimal_lambda)
time2<-Sys.time()
time2-time1

M_RNC<-as.matrix(fit$beta[1:11])
row.names(M_RNC)<-colnames(X.true[,2:12])
```
```{r}
print(M)
print(M_NL)
print(M_RNC)
```
#plot for School 1, School 22, School 27, School 31, School 48
```{r}
set.seed(1)
x<-as.factor(logit.school.data$SCHID)
index<-which(x %in% c("1"))
logit.school.data_sub<-logit.school.data[index,]
G_sub<-G[index,index]
USVT_reg<-USVT.orig(G_sub)
W<-logit.school.data_sub$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data_sub$NOMINF>0)
GPA<-logit.school.data_sub$GPA
gender<-as.numeric(logit.school.data_sub$GENDER)-1
grade<-as.numeric(logit.school.data_sub$GR)-1
treat<-as.numeric(logit.school.data_sub$TREAT==2)
ETHA<-as.numeric(logit.school.data_sub$ETHA)-1
ETHB<-as.numeric(logit.school.data_sub$ETHB)-1
ETHW<-as.numeric(logit.school.data_sub$ETHW)-1
ETHH<-as.numeric(logit.school.data_sub$ETHH)-1
HOSN<-as.numeric(logit.school.data_sub$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data_sub$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data_sub),ncol = 1)
g <- graph_from_adjacency_matrix(G_sub,weighted = TRUE, mode = "undirected")
# Example color vector X. Replace this with your actual color vector.

edge_weights <- E(g)$weight
edge_types <- ifelse(edge_weights == 0.5, "dotted", ifelse(edge_weights == 1, "solid", "invisible"))
layout <- layout_with_fr(g, grid = "nogrid")
color <- c(rgb(165,79,194,maxColorValue = 255),
          rgb(105,255,0,maxColorValue = 255))
colour <- ifelse(gender == 1, color[1], color[2])
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Male", "Female"),cex=1.2,col = color,pch=16)
color <- c(rgb(105,79,104,maxColorValue = 255),
          rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255))
colour <- ifelse(grade == 0, color[1], ifelse(grade == 1, color[2], ifelse(grade == 2, color[3], color[4])))

# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Grade 6", "Grade 7", "Grade 8"),cex=1.2,col = color[-1],pch=16)
color <- c(rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255),
          rgb(101,116,97,maxColorValue = 255),
          rgb(151,46,157,maxColorValue = 255))
colour <- ifelse(ETHW == 1, color[1], ifelse(ETHB == 1, color[2], ifelse(ETHH == 1, color[3], ifelse(ETHA == 1, color[4], color[5]))))
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("White","Black","Hispanic","Asian","Other"),cex=1,col = color,pch=16)
```
```{r}
set.seed(1)
index<-which(x %in% c("22"))
logit.school.data_sub<-logit.school.data[index,]
G_sub<-G[index,index]
USVT_reg<-USVT.orig(G_sub)
W<-logit.school.data_sub$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data_sub$NOMINF>0)
GPA<-logit.school.data_sub$GPA
gender<-as.numeric(logit.school.data_sub$GENDER)-1
grade<-as.numeric(logit.school.data_sub$GR)-1
treat<-as.numeric(logit.school.data_sub$TREAT==2)
ETHA<-as.numeric(logit.school.data_sub$ETHA)-1
ETHB<-as.numeric(logit.school.data_sub$ETHB)-1
ETHW<-as.numeric(logit.school.data_sub$ETHW)-1
ETHH<-as.numeric(logit.school.data_sub$ETHH)-1
HOSN<-as.numeric(logit.school.data_sub$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data_sub$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data_sub),ncol = 1)
g <- graph_from_adjacency_matrix(G_sub,weighted = TRUE, mode = "undirected")
# Example color vector X. Replace this with your actual color vector.

edge_weights <- E(g)$weight
edge_types <- ifelse(edge_weights == 0.5, "dotted", ifelse(edge_weights == 1, "solid", "invisible"))
layout <- layout_with_fr(g, grid = "nogrid")
color <- c(rgb(165,79,194,maxColorValue = 255),
          rgb(105,255,0,maxColorValue = 255))
colour <- ifelse(gender == 1, color[1], color[2])
# Assign colors to nodes based on vector X
V(g)$color <- colour

# Plot the network graph with colored nodes
par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Male", "Female"),cex=1.2,col = color,pch=16)
color <- c(rgb(105,79,104,maxColorValue = 255),
          rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255))
colour <- ifelse(grade == 0, color[1], ifelse(grade == 1, color[2], ifelse(grade == 2, color[3], color[4])))

# Assign colors to nodes based on vector X
V(g)$color <- colour

# Plot the network graph with colored nodes
par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Grade 6", "Grade 7", "Grade 8"),cex = 1.2,col = color[-1],pch=16)
color <- c(rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255),
          rgb(101,116,97,maxColorValue = 255),
          rgb(151,46,157,maxColorValue = 255))
colour <- ifelse(ETHW == 1, color[1], ifelse(ETHB == 1, color[2], ifelse(ETHH == 1, color[3], ifelse(ETHA == 1, color[4], color[5]))))
# Assign colors to nodes based on vector X
V(g)$color <- colour

# Plot the network graph with colored nodes
par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("White","Black","Hispanic","Asian","Other"),cex=1,col = color,pch=16)
```
```{r}
set.seed(1)
index<-which(x %in% c("27"))
logit.school.data_sub<-logit.school.data[index,]
G_sub<-G[index,index]
USVT_reg<-USVT.orig(G_sub)
W<-logit.school.data_sub$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data_sub$NOMINF>0)
GPA<-logit.school.data_sub$GPA
gender<-as.numeric(logit.school.data_sub$GENDER)-1
grade<-as.numeric(logit.school.data_sub$GR)-1
treat<-as.numeric(logit.school.data_sub$TREAT==2)
ETHA<-as.numeric(logit.school.data_sub$ETHA)-1
ETHB<-as.numeric(logit.school.data_sub$ETHB)-1
ETHW<-as.numeric(logit.school.data_sub$ETHW)-1
ETHH<-as.numeric(logit.school.data_sub$ETHH)-1
HOSN<-as.numeric(logit.school.data_sub$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data_sub$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data_sub),ncol = 1)
g <- graph_from_adjacency_matrix(G_sub,weighted = TRUE, mode = "undirected")
# Example color vector X. Replace this with your actual color vector.

edge_weights <- E(g)$weight
edge_types <- ifelse(edge_weights == 0.5, "dotted", ifelse(edge_weights == 1, "solid", "invisible"))
layout <- layout_with_fr(g, grid = "nogrid")
color <- c(rgb(165,79,194,maxColorValue = 255),
          rgb(105,255,0,maxColorValue = 255))
colour <- ifelse(gender == 1, color[1], color[2])
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Male", "Female"),cex=1.2,col = color,pch=16)
color <- c(rgb(105,79,104,maxColorValue = 255),
          rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255))
colour <- ifelse(grade == 0, color[1], ifelse(grade == 1, color[2], ifelse(grade == 2, color[3], color[4])))

# Assign colors to nodes based on vector X
V(g)$color <- colour

# Plot the network graph with colored nodes
par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Grade 5","Grade 6", "Grade 7", "Grade 8"),cex=1,col = color,pch=16)
color <- c(rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255),
          rgb(101,116,97,maxColorValue = 255),
          rgb(151,46,157,maxColorValue = 255))
colour <- ifelse(ETHW == 1, color[1], ifelse(ETHB == 1, color[2], ifelse(ETHH == 1, color[3], ifelse(ETHA == 1, color[4], color[5]))))
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("White","Black","Hispanic","Asian","Other"),cex=1,col = color,pch=16)
```
```{r}
set.seed(5)
index<-which(x %in% c("31"))
logit.school.data_sub<-logit.school.data[index,]
G_sub<-G[index,index]
USVT_reg<-USVT.orig(G_sub)
W<-logit.school.data_sub$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data_sub$NOMINF>0)
GPA<-logit.school.data_sub$GPA
gender<-as.numeric(logit.school.data_sub$GENDER)-1
grade<-as.numeric(logit.school.data_sub$GR)-1
treat<-as.numeric(logit.school.data_sub$TREAT==2)
ETHA<-as.numeric(logit.school.data_sub$ETHA)-1
ETHB<-as.numeric(logit.school.data_sub$ETHB)-1
ETHW<-as.numeric(logit.school.data_sub$ETHW)-1
ETHH<-as.numeric(logit.school.data_sub$ETHH)-1
HOSN<-as.numeric(logit.school.data_sub$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data_sub$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data_sub),ncol = 1)
g <- graph_from_adjacency_matrix(G_sub,weighted = TRUE, mode = "undirected")
# Example color vector X. Replace this with your actual color vector.

edge_weights <- E(g)$weight
edge_types <- ifelse(edge_weights == 0.5, "dotted", ifelse(edge_weights == 1, "solid", "invisible"))
layout <- layout_with_fr(g, grid = "nogrid")
color <- c(rgb(165,79,194,maxColorValue = 255),
          rgb(105,255,0,maxColorValue = 255))
colour <- ifelse(gender == 1, color[1], color[2])
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1,bty="l")
legend('bottomright',legend = c("Male", "Female"),cex=1.2,col = color,pch=16)
color <- c(rgb(105,79,104,maxColorValue = 255),
          rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255))
colour <- ifelse(grade == 0, color[1], ifelse(grade == 1, color[2], ifelse(grade == 2, color[3], color[4])))

# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Grade 5","Grade 6", "Grade 7", "Grade 8"),cex=1,col = color,pch=16)
color <- c(rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255),
          rgb(101,116,97,maxColorValue = 255),
          rgb(151,46,157,maxColorValue = 255))
colour <- ifelse(ETHW == 1, color[1], ifelse(ETHB == 1, color[2], ifelse(ETHH == 1, color[3], ifelse(ETHA == 1, color[4], color[5]))))
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("White","Black","Hispanic","Asian","Other"),cex=1,col = color,pch=16)
```

```{r}
set.seed(50)
index<-which(x %in% c("48"))
logit.school.data_sub<-logit.school.data[index,]
G_sub<-G[index,index]
USVT_reg<-USVT.orig(G_sub)
W<-logit.school.data_sub$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data_sub$NOMINF>0)
GPA<-logit.school.data_sub$GPA
gender<-as.numeric(logit.school.data_sub$GENDER)-1
grade<-as.numeric(logit.school.data_sub$GR)-1
treat<-as.numeric(logit.school.data_sub$TREAT==2)
ETHA<-as.numeric(logit.school.data_sub$ETHA)-1
ETHB<-as.numeric(logit.school.data_sub$ETHB)-1
ETHW<-as.numeric(logit.school.data_sub$ETHW)-1
ETHH<-as.numeric(logit.school.data_sub$ETHH)-1
HOSN<-as.numeric(logit.school.data_sub$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data_sub$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data_sub),ncol = 1)
g <- graph_from_adjacency_matrix(G_sub,weighted = TRUE, mode = "undirected")
# Example color vector X. Replace this with your actual color vector.

edge_weights <- E(g)$weight
edge_types <- ifelse(edge_weights == 0.5, "dotted", ifelse(edge_weights == 1, "solid", "invisible"))
layout <- layout_with_fr(g, grid = "nogrid")
color <- c(rgb(165,79,194,maxColorValue = 255),
          rgb(105,255,0,maxColorValue = 255))
colour <- ifelse(gender == 1, color[1], color[2])
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Male", "Female"),cex=1.2,col = color,pch=16)
color <- c(rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255))
colour <- ifelse(grade == 1, color[1], ifelse(grade == 2, color[2], color[3]))

# Assign colors to nodes based on vector X
V(g)$color <- colour

par(mar = c(1, 1, 1, 1),pty="s")
# Plot the network graph with colored nodes
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("Grade 6", "Grade 7", "Grade 8"),cex=1.2,col = color,pch=16)
color <- c(rgb(65,179,194,maxColorValue = 255),
          rgb(255,255,0,maxColorValue = 255),
          rgb(201,216,197,maxColorValue = 255),
          rgb(101,116,97,maxColorValue = 255),
          rgb(151,46,157,maxColorValue = 255))
colour <- ifelse(ETHW == 1, color[1], ifelse(ETHB == 1, color[2], ifelse(ETHH == 1, color[3], ifelse(ETHA == 1, color[4], color[5]))))
# Assign colors to nodes based on vector X
V(g)$color <- colour
# Plot the network graph with colored nodes

par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
legend('bottomright',legend = c("White","Black","Hispanic","Asian","Other"),cex=1,col = color,pch=16)
```


#school 3's network plot from wave I and wave II
```{r}
set.seed(1)
index<-which(x %in% c("3"))
logit.school.data_sub<-logit.school.data[index,]
G_sub<-A1[index,index]
USVT_reg<-USVT.orig(G_sub)
W<-logit.school.data_sub$WRISTOW2
DE<-as.numeric(W>1)
NOMINF<-as.numeric(logit.school.data_sub$NOMINF>0)
GPA<-logit.school.data_sub$GPA
gender<-as.numeric(logit.school.data_sub$GENDER)-1
grade<-as.numeric(logit.school.data_sub$GR)-1
treat<-as.numeric(logit.school.data_sub$TREAT==2)
ETHA<-as.numeric(logit.school.data_sub$ETHA)-1
ETHB<-as.numeric(logit.school.data_sub$ETHB)-1
ETHW<-as.numeric(logit.school.data_sub$ETHW)-1
ETHH<-as.numeric(logit.school.data_sub$ETHH)-1
HOSN<-as.numeric(logit.school.data_sub$HOSN)-1
Lan<-as.numeric(as.numeric(logit.school.data_sub$HLANG)>1)
intercept<-matrix(1,nrow = nrow(logit.school.data_sub),ncol = 1)
g <- graph_from_adjacency_matrix(G_sub,weighted = TRUE, mode = "undirected")
# Example color vector X. Replace this with your actual color vector.

edge_weights <- E(g)$weight
edge_types <- ifelse(edge_weights == 0.5, "dotted", ifelse(edge_weights == 1, "solid", "invisible"))
layout <- layout_with_fr(g, grid = "nogrid")

# Plot the network graph with colored nodes
par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)

G_sub<-A2[index,index]
g <- graph_from_adjacency_matrix(G_sub,weighted = TRUE, mode = "undirected")
# Example color vector X. Replace this with your actual color vector.

edge_weights <- E(g)$weight
edge_types <- ifelse(edge_weights == 0.5, "dotted", ifelse(edge_weights == 1, "solid", "invisible"))
# Plot the network graph with colored nodes
par(mar = c(1, 1, 1, 1),pty="s")
plot(g,layout = layout,vertex.label=NA,vertex.size=3, edge.width = 0.5,asp=1)
```



#overlapping percentage plot for 25 schools
```{r}
overlapping<-rep(0,length(unique(x)))
# Sample data (you can replace this with your actual data)
for (i in 1:length(unique(x))) {
  index<-which(x %in% unique(x)[i])
  logit.school.data_sub<-logit.school.data[index,]
  G_sub<-G[index,index]
  A1_sub<-A1[index,index]
  overlapping[i]=sum(G_sub==1)/sum(G_sub)
}

data <- overlapping

# Draw the histogram
h <- hist(data, 
          breaks = 10,                    # Set the number of bins (adjust as needed)   
          main = NA,
          xlab = "Edge Overlapping Proportion", # Use mathematical notation for x-axis
          ylab = "Frequency",             # y-axis label
          col = rgb(0.4, 0.6, 0.8, 0.5),  # Use semi-transparent color for bars
          border = "white",               # White border between bars
          xaxt = "n")                     # Suppress x-axis for custom labels

# Set custom x-axis ticks (optional, if you need specific values)
axis(1, at = seq(min(h$breaks), max(h$breaks), by = 0.05)) 

# Add box with border on all sides
box(lty = "solid")

# Optionally, add grid lines
abline(h = seq(0, max(h$counts), by = 10000), col = "lightgray", lty = "dotted")


```
```{r}
save(X,file="X.Rda")
save(X_SP,file="X_SP.Rda")
save(X_true,file="X_true.Rda")
save(X_Naive,file="X_Naive.Rda")
save(Y,file="Y.Rda")
save(Y_D,file="Y.Rda")
save(G,file="average_network.Rda")

```

